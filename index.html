<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Barcode GS1-128</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
        max-width: 500px;
        margin: auto;
      }
      video {
        border: 1px solid black;
        width: 100%;
        max-width: 400px;
      }
      .scanner-frame {
        position: absolute;
        top: 10%;
        left: 10%;
        width: 80%;
        height: 30%;
        border: 2px dashed red;
        box-sizing: border-box;
        pointer-events: none;
      }
      input, select, button {
        width: 100%;
        padding: 8px;
        margin-top: 5px;
        margin-bottom: 10px;
      }
      label {
        font-weight: bold;
      }
    </style>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
  </head>
  <body>
    <h2>Scan Barcode GS1-128</h2>
    <label for="cameraSelect">Pilih Kamera:</label>
    <select id="cameraSelect">
      <option value="auto">Preferensi Auto Focus & Zoom</option>
    </select>
    <div style="position: relative;">
      <video id="video" autoplay playsinline></video>
      <div class="scanner-frame"></div>
    </div>

    <label for="modeSelect">Mode Input:</label>
    <select id="modeSelect">
      <option value="scan">Scan Barcode</option>
      <option value="manual">Input Manual</option>
    </select>

    <form action="https://script.google.com/macros/s/AKfycbyuRpLVKpKB-kprbmNiZdJFujo4kxzXJbrR2sfL90y85zff01EcVhJ6Wol_Yj-6LXQU/exec" method="POST">
      <label>Barcode:</label>
      <input type="text" id="barcode" name="barcode" readonly required />

      <label>SKU:</label>
      <input type="text" id="sku" name="sku" disabled />

      <label>Nama:</label>
      <input type="text" name="nama" required />

      <label>Berat:</label>
      <input type="number" name="berat" required />

      <label>Issue:</label>
      <input type="text" name="issue" required />

      <label>NCM:</label>
      <input type="text" name="ncm" required />

      <button type="submit">Kirim</button>
    </form>

    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

    <script>
      const codeReader = new ZXing.BrowserMultiFormatReader();
      const videoElement = document.getElementById("video");
      const cameraSelect = document.getElementById("cameraSelect");
      const beepSound = document.getElementById("beep");
      const modeSelect = document.getElementById("modeSelect");
      const barcodeInput = document.getElementById("barcode");
      const skuInput = document.getElementById("sku");

      modeSelect.addEventListener("change", function () {
        const manual = this.value === "manual";
        barcodeInput.readOnly = !manual;
        skuInput.disabled = !manual;
        if (!manual) {
          skuInput.value = "";
        }
      });

      function startCamera(deviceId, useCustomPrefs = false) {
        codeReader.reset();
        const constraints = useCustomPrefs
          ? {
              video: {
                facingMode: "environment",
                focusMode: "continuous",
                zoom: 2 // mencoba zoom jika didukung
              }
            }
          : deviceId;

        codeReader.decodeFromVideoDevice(constraints, videoElement, (result, err) => {
          if (result) {
            barcodeInput.value = result.text;
            beepSound.play();
            skuInput.value = "";
          }
        });
      }

      codeReader.listVideoInputDevices().then((devices) => {
        devices.forEach((device) => {
          const option = document.createElement("option");
          option.value = device.deviceId;
          option.text = device.label || `Kamera ${cameraSelect.length}`;
          cameraSelect.appendChild(option);
        });

        // default kamera pertama
        if (devices.length > 0) {
          startCamera(devices[0].deviceId);
        }
      });

      cameraSelect.addEventListener("change", function () {
        if (this.value === "auto") {
          startCamera(null, true);
        } else {
          startCamera(this.value);
        }
      });
    </script>
  </body>
</html>
